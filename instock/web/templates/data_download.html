{% extends "layout/default.html" %}

{% block main_content %}
<!-- ç°ä»£åŒ–æ ·å¼å®šä¹‰ -->
<style>
:root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success-gradient: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
    --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    --hover-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    --border-radius: 12px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.modern-page {
    min-height: 100vh;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    padding: 20px 0;
}

.modern-header {
    text-align: center;
    margin-bottom: 40px;
    padding: 30px 0;
}

.modern-header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 10px;
}

.modern-header p {
    font-size: 1.1rem;
    color: #6c757d;
    font-weight: 300;
}

.modern-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: var(--transition);
    margin-bottom: 30px;
    overflow: hidden;
}

.modern-card:hover {
    box-shadow: var(--hover-shadow);
    transform: translateY(-5px);
}

.modern-card-header {
    background: var(--primary-gradient);
    color: white;
    padding: 20px 25px;
    border-bottom: none;
}

.modern-card-header h4 {
    margin: 0;
    font-weight: 600;
    font-size: 1.2rem;
}

.modern-card-body {
    padding: 30px 25px;
}

.modern-form-group {
    margin-bottom: 25px;
}

.modern-label {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
    display: block;
    font-size: 0.95rem;
}

.modern-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    transition: var(--transition);
    font-size: 1rem;
    background: white;
}

.modern-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    transform: translateY(-1px);
}

.modern-radio-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.modern-radio-item {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    transition: var(--transition);
    cursor: pointer;
    background: white;
}

.modern-radio-item:hover {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.05);
}

.modern-radio-item.active {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.1);
}

.modern-radio-item input[type="radio"] {
    margin-right: 12px;
    transform: scale(1.2);
}

.modern-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: var(--transition);
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    text-decoration: none;
}

.modern-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.modern-btn-primary {
    background: var(--primary-gradient);
    color: white;
}

.modern-btn-success {
    background: var(--success-gradient);
    color: white;
}

.modern-btn-warning {
    background: var(--warning-gradient);
    color: white;
}

.modern-btn-info {
    background: var(--info-gradient);
    color: white;
}

.modern-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.modern-progress {
    background: #e9ecef;
    border-radius: 10px;
    height: 8px;
    overflow: hidden;
    margin: 20px 0;
}

.modern-progress-bar {
    height: 100%;
    background: var(--success-gradient);
    border-radius: 10px;
    transition: width 0.3s ease;
}

.modern-alert {
    padding: 16px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid;
    background: white;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.modern-alert-info {
    border-left-color: #4facfe;
    background: linear-gradient(90deg, rgba(79, 172, 254, 0.1) 0%, rgba(255, 255, 255, 1) 20%);
}

.modern-alert-warning {
    border-left-color: #f093fb;
    background: linear-gradient(90deg, rgba(240, 147, 251, 0.1) 0%, rgba(255, 255, 255, 1) 20%);
}

.modern-alert-success {
    border-left-color: #4ecdc4;
    background: linear-gradient(90deg, rgba(78, 205, 196, 0.1) 0%, rgba(255, 255, 255, 1) 20%);
}

.modern-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.modern-stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    transition: var(--transition);
}

.modern-stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.modern-stat-number {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 5px;
}

.modern-stat-label {
    color: #6c757d;
    font-size: 0.9rem;
    font-weight: 500;
}

.modern-example-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
}

.modern-example-btn {
    padding: 12px 16px;
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    transition: var(--transition);
    cursor: pointer;
    text-align: center;
    font-size: 0.9rem;
}

.modern-example-btn:hover {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.05);
    transform: translateY(-2px);
}

.fade-in {
    animation: fadeIn 0.6s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.slide-up {
    animation: slideUp 0.4s ease-out;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .modern-header h1 {
        font-size: 2rem;
    }
    
    .modern-card-body {
        padding: 20px 15px;
    }
    
    .modern-stats {
        grid-template-columns: 1fr;
    }
    
    .modern-example-grid {
        grid-template-columns: 1fr;
    }
}

/* æ·±è‰²æ¨¡å¼æ”¯æŒ */
@media (prefers-color-scheme: dark) {
    .modern-page {
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    }
    
    .modern-card {
        background: rgba(45, 45, 45, 0.95);
        color: white;
    }
    
    .modern-input {
        background: #333;
        color: white;
        border-color: #555;
    }
    
    .modern-radio-item {
        background: #333;
        border-color: #555;
        color: white;
    }
}
</style>

<div class="modern-page">
    <div class="container">
        <div class="row">
        <div class="row">
            <!-- å·¦ä¾§ï¼šä¸‹è½½é…ç½® -->
            <div class="col-lg-6 col-md-12">
                <div class="modern-card slide-up">
                    <div class="modern-card-header">
                        <h4><i class="fa fa-cog"></i> è‚¡ç¥¨æ•°æ®ä¸‹è½½é…ç½®</h4>
                    </div>
                    
                    <div class="modern-card-body">
                        <form id="downloadForm">
                            <div class="modern-form-group">
                                <label class="modern-label">
                                    <i class="fa fa-search"></i> æ£€æŸ¥èŒƒå›´
                                </label>
                                <div class="modern-radio-group">
                                    <div class="modern-radio-item active" data-value="single">
                                        <input type="radio" name="checkScope" value="single" checked>
                                        <div>
                                            <strong>å•ä¸ªè‚¡ç¥¨æ£€æŸ¥</strong>
                                            <div style="font-size: 0.85rem; color: #6c757d; margin-top: 2px;">
                                                ç²¾å‡†æ£€æŸ¥æŒ‡å®šè‚¡ç¥¨çš„æ•°æ®å®Œæ•´æ€§
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modern-radio-item" data-value="all">
                                        <input type="radio" name="checkScope" value="all">
                                        <div>
                                            <strong>å…¨é‡æ•°æ®æ£€æŸ¥</strong>
                                            <div style="font-size: 0.85rem; color: #6c757d; margin-top: 2px;">
                                                æ£€æŸ¥æ‰€æœ‰è‚¡ç¥¨çš„æ•°æ®å®Œæ•´æ€§ï¼ˆè€—æ—¶è¾ƒé•¿ï¼‰
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modern-radio-item" data-value="market">
                                        <input type="radio" name="checkScope" value="market">
                                        <div>
                                            <strong>æŒ‰å¸‚åœºæ£€æŸ¥</strong>
                                            <div style="font-size: 0.85rem; color: #6c757d; margin-top: 2px;">
                                                åˆ†åˆ«æ£€æŸ¥æ²ªæ·±åŒ—å„äº¤æ˜“æ‰€æ•°æ®
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="modern-form-group" id="stockCodeGroup">
                                <label class="modern-label" for="stockCode">
                                    <i class="fa fa-code"></i> è‚¡ç¥¨ä»£ç 
                                </label>
                                <input type="text" id="stockCode" class="modern-input" 
                                       placeholder="è¯·è¾“å…¥6ä½è‚¡ç¥¨ä»£ç ï¼Œå¦‚ï¼š600000" maxlength="6">
                                <div style="font-size: 0.85rem; color: #6c757d; margin-top: 5px;">
                                    <i class="fa fa-info-circle"></i> æ”¯æŒæ²ªæ·±åŒ—ä¸‰å¤§äº¤æ˜“æ‰€è‚¡ç¥¨ä»£ç 
                                </div>
                            </div>
                            
                            <div class="modern-form-group" id="marketGroup" style="display: none;">
                                <label class="modern-label" for="marketSelect">
                                    <i class="fa fa-building"></i> å¸‚åœºé€‰æ‹©
                                </label>
                                <select id="marketSelect" class="modern-input">
                                    <option value="SH">ğŸ›ï¸ ä¸Šæµ·äº¤æ˜“æ‰€ (SH)</option>
                                    <option value="SZ">ğŸ¢ æ·±åœ³äº¤æ˜“æ‰€ (SZ)</option>
                                    <option value="BJ">ğŸ¤ åŒ—äº¬äº¤æ˜“æ‰€ (BJ)</option>
                                    <option value="ALL">ğŸŒ å…¨éƒ¨å¸‚åœº</option>
                                </select>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="modern-form-group">
                                        <label class="modern-label" for="startDate">
                                            <i class="fa fa-calendar"></i> å¼€å§‹æ—¥æœŸ
                                        </label>
                                        <input type="date" id="startDate" class="modern-input">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="modern-form-group">
                                        <label class="modern-label" for="endDate">
                                            <i class="fa fa-calendar"></i> ç»“æŸæ—¥æœŸ
                                        </label>
                                        <input type="date" id="endDate" class="modern-input" value="{{date_now}}">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="modern-form-group">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="writeToDb" style="transform: scale(1.2);">
                                    <label for="writeToDb" style="margin: 0; font-weight: 500;">
                                        <i class="fa fa-database"></i> ä¸‹è½½åè‡ªåŠ¨å†™å…¥æ•°æ®åº“
                                    </label>
                                </div>
                                <div style="font-size: 0.85rem; color: #6c757d; margin-top: 5px; margin-left: 30px;">
                                    å‹¾é€‰åå°†è‡ªåŠ¨å»é‡å¹¶å†™å…¥ClickHouseæ•°æ®åº“
                                </div>
                            </div>
                            
                            <div class="modern-form-group" style="margin-top: 30px;">
                                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                    <button type="button" class="modern-btn modern-btn-info" id="checkDataBtn">
                                        <i class="fa fa-search"></i> æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
                                    </button>
                                    <button type="button" class="modern-btn modern-btn-success" id="downloadBtn" disabled>
                                        <i class="fa fa-download"></i> å¼€å§‹ä¸‹è½½
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- å¿«é€Ÿç¤ºä¾‹ -->
                <div class="modern-card slide-up" style="animation-delay: 0.1s;">
                    <div class="modern-card-header" style="background: var(--success-gradient);">
                        <h4><i class="fa fa-star"></i> çƒ­é—¨è‚¡ç¥¨å¿«é€‰</h4>
                    </div>
                    
                    <div class="modern-card-body">
                        <div class="modern-example-grid">
                            <div class="modern-example-btn" onclick="fillExample('600000', 'æµ¦å‘é“¶è¡Œ')">
                                <div style="font-weight: 600;">600000</div>
                                <div style="font-size: 0.85rem; color: #6c757d;">æµ¦å‘é“¶è¡Œ</div>
                            </div>
                            <div class="modern-example-btn" onclick="fillExample('000001', 'å¹³å®‰é“¶è¡Œ')">
                                <div style="font-weight: 600;">000001</div>
                                <div style="font-size: 0.85rem; color: #6c757d;">å¹³å®‰é“¶è¡Œ</div>
                            </div>
                            <div class="modern-example-btn" onclick="fillExample('600036', 'æ‹›å•†é“¶è¡Œ')">
                                <div style="font-weight: 600;">600036</div>
                                <div style="font-size: 0.85rem; color: #6c757d;">æ‹›å•†é“¶è¡Œ</div>
                            </div>
                            <div class="modern-example-btn" onclick="fillExample('600519', 'è´µå·èŒ…å°')">
                                <div style="font-weight: 600;">600519</div>
                                <div style="font-size: 0.85rem; color: #6c757d;">è´µå·èŒ…å°</div>
                            </div>
                            <div class="modern-example-btn" onclick="fillExample('000002', 'ä¸‡ç§‘A')">
                                <div style="font-weight: 600;">000002</div>
                                <div style="font-size: 0.85rem; color: #6c757d;">ä¸‡ç§‘A</div>
                            </div>
                            <div class="modern-example-btn" onclick="fillExample('831827', 'å¾·åŠ›è‚¡ä»½')">
                                <div style="font-weight: 600;">831827</div>
                                <div style="font-size: 0.85rem; color: #6c757d;">å¾·åŠ›è‚¡ä»½(BJ)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šæ•°æ®çŠ¶æ€å’Œä¸‹è½½è¿›åº¦ -->
            <div class="col-lg-6 col-md-12">
                <!-- æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ç»“æœ -->
                <div class="modern-card slide-up" id="checkResultBox" style="display: none; animation-delay: 0.2s;">
                    <div class="modern-card-header" style="background: var(--info-gradient);">
                        <h4><i class="fa fa-chart-pie"></i> æ•°æ®å®Œæ•´æ€§åˆ†æ</h4>
                    </div>
                    
                    <div class="modern-card-body" id="checkResult">
                        <!-- æ£€æŸ¥ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
                
                <!-- ä¸‹è½½è¿›åº¦ -->
                <div class="modern-card slide-up" id="progressBox" style="display: none; animation-delay: 0.3s;">
                    <div class="modern-card-header" style="background: var(--warning-gradient);">
                        <h4><i class="fa fa-tasks"></i> ä»»åŠ¡è¿›åº¦ç›‘æ§</h4>
                    </div>
                    
                    <div class="modern-card-body">
                        <div class="modern-progress">
                            <div class="modern-progress-bar" id="progressBar" style="width: 0%"></div>
                        </div>
                        <p id="progressMessage" style="text-align: center; margin: 15px 0; font-weight: 500;">ç­‰å¾…å¼€å§‹...</p>
                        <div id="downloadResult" style="display: none;">
                            <!-- ä¸‹è½½ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                </div>
                
                <!-- æ“ä½œæŒ‡å— -->
                <div class="modern-card slide-up" style="animation-delay: 0.4s;">
                    <div class="modern-card-header" style="background: var(--dark-gradient);">
                        <h4><i class="fa fa-graduation-cap"></i> ä½¿ç”¨æŒ‡å—</h4>
                    </div>
                    
                    <div class="modern-card-body">
                        <div class="modern-alert modern-alert-info">
                            <h5 style="margin-bottom: 15px;"><i class="fa fa-lightbulb-o"></i> å¿«é€Ÿä¸Šæ‰‹</h5>
                            <ol style="margin: 0; padding-left: 20px;">
                                <li style="margin-bottom: 8px;">é€‰æ‹©æ£€æŸ¥èŒƒå›´å¹¶è¾“å…¥è‚¡ç¥¨ä»£ç æˆ–é€‰æ‹©å¸‚åœº</li>
                                <li style="margin-bottom: 8px;">è®¾ç½®æŸ¥è¯¢æ—¶é—´èŒƒå›´ï¼ˆå»ºè®®ä¸è¶…è¿‡2å¹´ï¼‰</li>
                                <li style="margin-bottom: 8px;">ç‚¹å‡»"æ£€æŸ¥æ•°æ®å®Œæ•´æ€§"åˆ†æç°æœ‰æ•°æ®</li>
                                <li style="margin-bottom: 8px;">å¦‚æœ‰ç¼ºå¤±å¯é€‰æ‹©æ‰¹é‡è¡¥é½æ•°æ®</li>
                                <li style="margin-bottom: 8px;">ç‚¹å‡»"å¼€å§‹ä¸‹è½½"ç”ŸæˆCSVæ–‡ä»¶</li>
                            </ol>
                        </div>
                        
                        <div class="modern-alert modern-alert-warning">
                            <h5 style="margin-bottom: 15px;"><i class="fa fa-exclamation-triangle"></i> é‡è¦æç¤º</h5>
                            <div style="display: grid; gap: 8px;">
                                <div><i class="fa fa-clock-o"></i> å¤§é‡æ•°æ®å¤„ç†å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´</div>
                                <div><i class="fa fa-database"></i> æ²ªæ·±è‚¡ç¥¨ä½¿ç”¨baostockæ•°æ®æº</div>
                                <div><i class="fa fa-cloud"></i> åŒ—äº¬è‚¡ç¥¨ä½¿ç”¨tushareæ•°æ®æº</div>
                                <div><i class="fa fa-file-excel-o"></i> æ”¯æŒå®Œæ•´OHLCæ•°æ®å¯¼å‡º</div>
                            </div>
                        </div>
                        
                        <div class="modern-stats">
                            <div class="modern-stat-card">
                                <div class="modern-stat-number" style="color: #667eea;">3</div>
                                <div class="modern-stat-label">æ”¯æŒäº¤æ˜“æ‰€</div>
                            </div>
                            <div class="modern-stat-card">
                                <div class="modern-stat-number" style="color: #4ecdc4;">5000+</div>
                                <div class="modern-stat-label">è¦†ç›–è‚¡ç¥¨</div>
                            </div>
                            <div class="modern-stat-card">
                                <div class="modern-stat-number" style="color: #f093fb;">15+</div>
                                <div class="modern-stat-label">æ•°æ®å­—æ®µ</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç°ä»£åŒ–æ•°æ®è¡¥é½å¯¹è¯æ¡† -->
<div class="modal fade" id="supplementModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" style="border: none; border-radius: 12px; overflow: hidden;">
            <div class="modal-header" style="background: var(--primary-gradient); color: white; border: none; padding: 25px;">
                <h4 class="modal-title" style="margin: 0; font-weight: 600;">
                    <i class="fa fa-magic"></i> æ™ºèƒ½æ•°æ®è¡¥é½
                </h4>
                <button type="button" class="close" data-dismiss="modal" style="color: white; opacity: 0.8; font-size: 1.5rem;">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" style="padding: 30px;">
                <div class="modern-alert modern-alert-info">
                    <i class="fa fa-info-circle"></i> 
                    æ£€æµ‹åˆ°æ‚¨è¦ä¸‹è½½çš„æ•°æ®å­˜åœ¨ç¼ºå¤±ï¼Œæˆ‘ä»¬ä¸ºæ‚¨æä¾›ä¸€é”®è¡¥é½æœåŠ¡ï¼
                </div>
                
                <div id="missingDataDetails" style="margin: 20px 0;">
                    <!-- ç¼ºå¤±æ•°æ®è¯¦æƒ…å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                
                <div class="modern-alert modern-alert-success">
                    <h5 style="margin-bottom: 15px;"><i class="fa fa-cogs"></i> æ™ºèƒ½è¡¥é½ç­–ç•¥</h5>
                    <div style="display: grid; gap: 10px;">
                        <div><i class="fa fa-check-circle" style="color: #4ecdc4;"></i> æ²ªæ·±è‚¡ç¥¨ï¼šbaostocké«˜è´¨é‡æ•°æ®æº</div>
                        <div><i class="fa fa-check-circle" style="color: #4ecdc4;"></i> åŒ—äº¬è‚¡ç¥¨ï¼štushareä¸“ä¸šæ•°æ®æº</div>
                        <div><i class="fa fa-check-circle" style="color: #4ecdc4;"></i> è‡ªåŠ¨å»é‡ä¸æ•°æ®éªŒè¯</div>
                        <div><i class="fa fa-check-circle" style="color: #4ecdc4;"></i> æ”¯æŒæ–­ç‚¹ç»­ä¼ ä¸æ‰¹é‡å¤„ç†</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding: 20px 30px; border: none; background: #f8f9fa;">
                <button type="button" class="modern-btn" data-dismiss="modal" 
                        style="background: #6c757d; color: white;">
                    <i class="fa fa-times"></i> è·³è¿‡è¡¥é½
                </button>
                <button type="button" class="modern-btn modern-btn-primary" id="confirmSupplementBtn">
                    <i class="fa fa-magic"></i> å¼€å§‹è¡¥é½
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// å…¨å±€å˜é‡
let currentTaskId = null;
let checkResultData = null;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
$(document).ready(function() {
    // åˆå§‹åŒ–ç°ä»£åŒ–äº¤äº’
    initModernInteractions();
    
    // è®¾ç½®é»˜è®¤å¼€å§‹æ—¥æœŸä¸ºä¸€å¹´å‰
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
    document.getElementById('startDate').valueAsDate = oneYearAgo;
    
    // ç»‘å®šäº‹ä»¶
    $('#checkDataBtn').click(checkDataCompleteness);
    $('#downloadBtn').click(startDownload);
    $('#confirmSupplementBtn').click(confirmSupplement);
    
    // ç°ä»£åŒ–å•é€‰æ¡†å¤„ç†
    $('.modern-radio-item').click(function() {
        const radioInput = $(this).find('input[type="radio"]');
        radioInput.prop('checked', true);
        $('.modern-radio-item').removeClass('active');
        $(this).addClass('active');
        
        // è§¦å‘åŸæœ‰çš„changeäº‹ä»¶
        radioInput.trigger('change');
    });
    
    // æ£€æŸ¥èŒƒå›´å˜åŒ–å¤„ç†
    $('input[name="checkScope"]').change(function() {
        const scope = $(this).val();
        
        // æ·»åŠ å¹³æ»‘è¿‡æ¸¡æ•ˆæœ
        if (scope === 'single') {
            $('#marketGroup').slideUp(200);
            setTimeout(() => $('#stockCodeGroup').slideDown(200), 100);
            $('#stockCode').prop('required', true);
        } else if (scope === 'market') {
            $('#stockCodeGroup').slideUp(200);
            setTimeout(() => $('#marketGroup').slideDown(200), 100);
            $('#stockCode').prop('required', false);
        } else { // all
            $('#stockCodeGroup').slideUp(200);
            $('#marketGroup').slideUp(200);
            $('#stockCode').prop('required', false);
        }
        
        // é‡ç½®æŒ‰é’®çŠ¶æ€
        updateCheckButtonState();
    });
    
    // è‚¡ç¥¨ä»£ç è¾“å…¥éªŒè¯
    $('#stockCode').on('input', function() {
        updateCheckButtonState();
        
        // å®æ—¶éªŒè¯åé¦ˆ
        const code = $(this).val();
        if (code.length === 6 && /^\d{6}$/.test(code)) {
            $(this).css('border-color', '#4ecdc4');
        } else if (code.length > 0) {
            $(this).css('border-color', '#f093fb');
        } else {
            $(this).css('border-color', '#e9ecef');
        }
    });
    
    // è¾“å…¥æ¡†ç„¦ç‚¹æ•ˆæœ
    $('.modern-input').focus(function() {
        $(this).parent().addClass('focused');
    }).blur(function() {
        $(this).parent().removeClass('focused');
    });
});

// åˆå§‹åŒ–ç°ä»£åŒ–äº¤äº’æ•ˆæœ
function initModernInteractions() {
    // æ·»åŠ é¡µé¢åŠ è½½åŠ¨ç”»
    $('.modern-card').each(function(index) {
        $(this).css('animation-delay', (index * 0.1) + 's');
    });
    
    // æŒ‰é’®ç‚¹å‡»æ³¢çº¹æ•ˆæœ
    $('.modern-btn').click(function(e) {
        const btn = $(this);
        const ripple = $('<span class="ripple"></span>');
        const rect = this.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = e.clientX - rect.left - size / 2;
        const y = e.clientY - rect.top - size / 2;
        
        ripple.css({
            width: size,
            height: size,
            left: x,
            top: y
        }).appendTo(btn);
        
        setTimeout(() => ripple.remove(), 600);
    });
    
    // æ·»åŠ æ³¢çº¹æ•ˆæœæ ·å¼
    if (!$('#ripple-style').length) {
        $('<style id="ripple-style">').text(`
            .modern-btn {
                position: relative;
                overflow: hidden;
            }
            .ripple {
                position: absolute;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.6);
                transform: scale(0);
                animation: ripple-effect 0.6s linear;
                pointer-events: none;
            }
            @keyframes ripple-effect {
                to {
                    transform: scale(4);
                    opacity: 0;
                }
            }
        `).appendTo('head');
    }
}

// æ›´æ–°æ£€æŸ¥æŒ‰é’®çŠ¶æ€
function updateCheckButtonState() {
    const scope = $('input[name="checkScope"]:checked').val();
    let canCheck = false;
    
    if (scope === 'single') {
        const code = $('#stockCode').val();
        canCheck = code.length === 6 && /^\d{6}$/.test(code);
        
        if (canCheck) {
            $('#stockCode').removeClass('has-error').addClass('has-success');
        } else {
            $('#stockCode').removeClass('has-success').addClass('has-error');
        }
    } else {
        // å…¨é‡æˆ–å¸‚åœºæ£€æŸ¥ä¸éœ€è¦éªŒè¯è‚¡ç¥¨ä»£ç 
        canCheck = true;
        $('#stockCode').removeClass('has-error has-success');
    }
    
    $('#checkDataBtn').prop('disabled', !canCheck);
    if (!canCheck) {
        $('#downloadBtn').prop('disabled', true);
    }
}

// å¡«å……ç¤ºä¾‹æ•°æ®
function fillExample(code, name) {
    $('#stockCode').val(code).trigger('input');
    
    // è®¾ç½®æ—¶é—´èŒƒå›´ä¸ºæœ€è¿‘ä¸€å¹´
    const endDate = new Date();
    const startDate = new Date();
    startDate.setFullYear(startDate.getFullYear() - 1);
    
    document.getElementById('startDate').valueAsDate = startDate;
    document.getElementById('endDate').valueAsDate = endDate;
}

// æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
function checkDataCompleteness() {
    const scope = $('input[name="checkScope"]:checked').val();
    const startDate = $('#startDate').val();
    const endDate = $('#endDate').val();
    
    if (!startDate || !endDate) {
        showAlert('è¯·å¡«å†™å®Œæ•´çš„æ—¶é—´èŒƒå›´', 'warning');
        return;
    }
    
    if (new Date(startDate) >= new Date(endDate)) {
        showAlert('å¼€å§‹æ—¥æœŸå¿…é¡»æ—©äºç»“æŸæ—¥æœŸ', 'warning');
        return;
    }
    
    let requestData = {
        action: 'check_data',
        check_scope: scope,
        start_date: startDate,
        end_date: endDate
    };
    
    if (scope === 'single') {
        const stockCode = $('#stockCode').val().trim();
        if (!stockCode || !/^\d{6}$/.test(stockCode)) {
            showAlert('è¯·è¾“å…¥æ­£ç¡®çš„6ä½è‚¡ç¥¨ä»£ç ', 'warning');
            return;
        }
        requestData.stock_code = stockCode;
    } else if (scope === 'market') {
        requestData.market = $('#marketSelect').val();
    }
    
    // æ˜¾ç¤ºloading
    $('#checkDataBtn').prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> æ£€æŸ¥ä¸­...');
    
    // å‘é€æ£€æŸ¥è¯·æ±‚
    $.post('/instock/data_download_api', requestData, function(response) {
        if (response.success) {
            checkResultData = response;
            if (scope === 'single') {
                showCheckResult(response);
            } else {
                showBatchCheckResult(response);
            }
            $('#downloadBtn').prop('disabled', false);
        } else {
            showAlert(response.message, 'danger');
        }
    }).fail(function() {
        showAlert('æ£€æŸ¥è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'danger');
    }).always(function() {
        $('#checkDataBtn').prop('disabled', false).html('<i class="fa fa-search"></i> æ£€æŸ¥æ•°æ®å®Œæ•´æ€§');
    });
}

// æ˜¾ç¤ºæ£€æŸ¥ç»“æœ
function showCheckResult(data) {
    const completeness = data.completeness;
    const hasLoss = data.has_missing;
    
    let statusGradient = 'var(--success-gradient)';
    let statusIcon = 'check-circle';
    let statusText = 'æ•°æ®å®Œæ•´';
    let statusColor = '#4ecdc4';
    
    if (completeness < 50) {
        statusGradient = 'var(--warning-gradient)';
        statusIcon = 'exclamation-triangle';
        statusText = 'ä¸¥é‡ç¼ºå¤±';
        statusColor = '#f093fb';
    } else if (completeness < 90) {
        statusGradient = 'var(--info-gradient)';
        statusIcon = 'info-circle';
        statusText = 'éƒ¨åˆ†ç¼ºå¤±';
        statusColor = '#4facfe';
    }
    
    const resultHtml = `
        <div class="modern-stats" style="margin-bottom: 25px;">
            <div class="modern-stat-card" style="background: ${statusGradient}; color: white;">
                <div class="modern-stat-number">
                    <i class="fa fa-${statusIcon}" style="font-size: 1.5rem;"></i>
                </div>
                <div class="modern-stat-label" style="color: rgba(255,255,255,0.9);">${statusText}</div>
            </div>
            <div class="modern-stat-card">
                <div class="modern-stat-number" style="color: ${statusColor};">${completeness}%</div>
                <div class="modern-stat-label">å®Œæ•´æ€§</div>
            </div>
        </div>
        
        <div class="row" style="margin-bottom: 20px;">
            <div class="col-md-6">
                <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 8px;">
                    <h6 style="color: #2c3e50; margin-bottom: 15px; font-weight: 600;">
                        <i class="fa fa-info-circle"></i> åŸºæœ¬ä¿¡æ¯
                    </h6>
                    <div style="display: grid; gap: 8px; font-size: 0.9rem;">
                        <div><strong>è‚¡ç¥¨ä»£ç :</strong> ${data.stock_code} (${data.market})</div>
                        <div><strong>æŸ¥è¯¢èŒƒå›´:</strong> ${data.start_date} ~ ${data.end_date}</div>
                        ${data.ipo_date ? `<div><strong>ä¸Šå¸‚æ—¥æœŸ:</strong> ${data.ipo_date}</div>` : ''}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 8px;">
                    <h6 style="color: #2c3e50; margin-bottom: 15px; font-weight: 600;">
                        <i class="fa fa-chart-bar"></i> æ•°æ®ç»Ÿè®¡
                    </h6>
                    <div style="display: grid; gap: 8px; font-size: 0.9rem;">
                        <div><strong>åº”æœ‰æ•°æ®:</strong> <span style="color: #667eea;">${data.total_expected} æ¡</span></div>
                        <div><strong>ç°æœ‰æ•°æ®:</strong> <span style="color: #4ecdc4;">${data.existing_count} æ¡</span></div>
                        <div><strong>ç¼ºå¤±æ•°æ®:</strong> <span style="color: ${statusColor};">${data.missing_count} æ¡</span></div>
                    </div>
                </div>
            </div>
        </div>
        
        ${hasLoss ? `
        <div class="modern-alert modern-alert-warning" style="margin-top: 20px;">
            <h5 style="margin-bottom: 15px;"><i class="fa fa-exclamation-triangle"></i> æ£€æµ‹åˆ°æ•°æ®ç¼ºå¤±</h5>
            <p style="margin-bottom: 15px;">ä¸ºç¡®ä¿æ•°æ®å®Œæ•´æ€§ï¼Œå»ºè®®å…ˆè¡¥é½ç¼ºå¤±æ•°æ®åå†ä¸‹è½½ã€‚</p>
            <button type="button" class="modern-btn modern-btn-warning" onclick="showSupplementModal()">
                <i class="fa fa-magic"></i> ä¸€é”®è¡¥é½æ•°æ®
            </button>
        </div>
        ` : `
        <div class="modern-alert modern-alert-success">
            <i class="fa fa-check-circle"></i> æ•°æ®å®Œæ•´ï¼Œå¯ä»¥ç›´æ¥ä¸‹è½½
        </div>
        `}
    `;
    
    $('#checkResult').html(resultHtml);
    $('#checkResultBox').slideDown(300);
}

// æ˜¾ç¤ºè¯¦ç»†ç»“æœ
function showDetailedResults() {
    $('#detailedResults').toggle();
}

// æ˜¾ç¤ºæ‰¹é‡æ•°æ®è¡¥é½å¯¹è¯æ¡†
function showBatchSupplementModal() {
    if (!checkResultData || !checkResultData.summary) {
        return;
    }
    
    const summary = checkResultData.summary;
    const totalMissing = summary.partial_missing + summary.severe_missing;
    
    const detailsHtml = `
        <div class="alert alert-info">
            <strong>æ‰¹é‡è¡¥é½ç»Ÿè®¡ï¼š</strong><br>
            å…±æœ‰ <strong>${totalMissing}</strong> åªè‚¡ç¥¨éœ€è¦è¡¥é½æ•°æ®<br>
            éƒ¨åˆ†ç¼ºå¤±: <strong>${summary.partial_missing}</strong> åª &nbsp; 
            ä¸¥é‡ç¼ºå¤±: <strong>${summary.severe_missing}</strong> åª<br>
            æ£€æŸ¥èŒƒå›´: <strong>${checkResultData.check_scope === 'market' ? checkResultData.market + 'å¸‚åœº' : 'å…¨é‡æ•°æ®'}</strong>
        </div>
        
        <div class="well">
            <strong>è¡¥é½ç­–ç•¥ï¼š</strong><br>
            <ul>
                <li>ä¼˜å…ˆè¡¥é½ä¸¥é‡ç¼ºå¤±çš„è‚¡ç¥¨ï¼ˆå®Œæ•´æ€§&lt;50%ï¼‰</li>
                <li>æ²ªæ·±è‚¡ç¥¨ä½¿ç”¨baostockæ•°æ®æº</li>
                <li><span class="text-info">åŒ—äº¬è‚¡ç¥¨ä½¿ç”¨tushareæ•°æ®æº</span></li>
                <li>æ”¯æŒæ‰¹é‡å¹¶å‘å¤„ç†ï¼Œæé«˜æ•ˆç‡</li>
            </ul>
        </div>
        
        <div class="alert alert-warning">
            <strong>æ³¨æ„ï¼š</strong>æ‰¹é‡è¡¥é½å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚æ²ªæ·±è‚¡ç¥¨ä½¿ç”¨baostockæ•°æ®æºï¼ŒåŒ—äº¬è‚¡ç¥¨ä½¿ç”¨tushareæ•°æ®æºã€‚è¡¥é½å®Œæˆåè¯·é‡æ–°æ£€æŸ¥æ•°æ®å®Œæ•´æ€§ã€‚
        </div>
    `;
    
    $('#missingDataDetails').html(detailsHtml);
    $('#supplementModal').modal('show');
}

// æ˜¾ç¤ºæ‰¹é‡æ£€æŸ¥ç»“æœ
function showBatchCheckResult(data) {
    const scope = data.check_scope;
    const summary = data.summary;
    const details = data.details || [];
    
    let scopeText = '';
    if (scope === 'all') {
        scopeText = 'å…¨é‡æ•°æ®';
    } else if (scope === 'market') {
        scopeText = `${data.market}å¸‚åœº`;
    }
    
    const completionRate = ((summary.complete_stocks / summary.total_stocks) * 100).toFixed(1);
    const partialRate = ((summary.partial_missing / summary.total_stocks) * 100).toFixed(1);
    const severeRate = ((summary.severe_missing / summary.total_stocks) * 100).toFixed(1);
    
    const resultHtml = `
        <div class="modern-alert modern-alert-info" style="margin-bottom: 25px;">
            <h5 style="margin-bottom: 10px;"><i class="fa fa-database"></i> ${scopeText}å®Œæ•´æ€§åˆ†ææŠ¥å‘Š</h5>
            <p style="margin: 0;"><strong>åˆ†æèŒƒå›´:</strong> ${data.start_date} ~ ${data.end_date}</p>
        </div>
        
        <div class="modern-stats" style="margin-bottom: 25px;">
            <div class="modern-stat-card">
                <div class="modern-stat-number" style="color: #667eea;">${summary.total_stocks}</div>
                <div class="modern-stat-label">æ€»è‚¡ç¥¨æ•°</div>
            </div>
            <div class="modern-stat-card">
                <div class="modern-stat-number" style="color: #4ecdc4;">${summary.complete_stocks}</div>
                <div class="modern-stat-label">å®Œæ•´è‚¡ç¥¨</div>
            </div>
            <div class="modern-stat-card">
                <div class="modern-stat-number" style="color: #4facfe;">${summary.partial_missing}</div>
                <div class="modern-stat-label">éƒ¨åˆ†ç¼ºå¤±</div>
            </div>
            <div class="modern-stat-card">
                <div class="modern-stat-number" style="color: #f093fb;">${summary.severe_missing}</div>
                <div class="modern-stat-label">ä¸¥é‡ç¼ºå¤±</div>
            </div>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <h6 style="margin-bottom: 15px; color: #2c3e50;"><i class="fa fa-chart-pie"></i> æ•°æ®å®Œæ•´æ€§åˆ†å¸ƒ</h6>
            <div style="background: #f8f9fa; border-radius: 6px; height: 20px; overflow: hidden; margin-bottom: 15px;">
                <div style="background: var(--success-gradient); height: 100%; width: ${completionRate}%; float: left;"></div>
                <div style="background: var(--info-gradient); height: 100%; width: ${partialRate}%; float: left;"></div>
                <div style="background: var(--warning-gradient); height: 100%; width: ${severeRate}%; float: left;"></div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                <div style="text-align: center;">
                    <div style="color: #4ecdc4; font-weight: 600;">${completionRate}%</div>
                    <div style="color: #6c757d;">å®Œæ•´æ•°æ®</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: #4facfe; font-weight: 600;">${partialRate}%</div>
                    <div style="color: #6c757d;">éƒ¨åˆ†ç¼ºå¤±</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: #f093fb; font-weight: 600;">${severeRate}%</div>
                    <div style="color: #6c757d;">ä¸¥é‡ç¼ºå¤±</div>
                </div>
            </div>
        </div>
        
        ${(summary.partial_missing > 0 || summary.severe_missing > 0) ? `
        <div class="modern-alert modern-alert-warning">
            <h5 style="margin-bottom: 15px;"><i class="fa fa-exclamation-triangle"></i> å‘ç°æ•°æ®ç¼ºå¤±</h5>
            <p style="margin-bottom: 15px;">å…±æœ‰ <strong>${summary.partial_missing + summary.severe_missing}</strong> åªè‚¡ç¥¨å­˜åœ¨æ•°æ®ç¼ºå¤±ã€‚</p>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button type="button" class="modern-btn modern-btn-warning" onclick="showBatchSupplementModal()">
                    <i class="fa fa-magic"></i> æ‰¹é‡è¡¥é½æ•°æ®
                </button>
                <button type="button" class="modern-btn modern-btn-info" onclick="showDetailedResults()">
                    <i class="fa fa-list"></i> æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š
                </button>
            </div>
        </div>
        ` : `
        <div class="modern-alert modern-alert-success">
            <i class="fa fa-check-circle"></i> æ‰€æœ‰è‚¡ç¥¨æ•°æ®å®Œæ•´ï¼Œå¯ä»¥ç›´æ¥ä¸‹è½½
        </div>
        `}
        
        ${details.length > 0 ? `
        <div id="detailedResults" style="display: none; margin-top: 20px;">
            <h6 style="color: #2c3e50; margin-bottom: 15px;"><i class="fa fa-table"></i> è¯¦ç»†ç¼ºå¤±æŠ¥å‘Š (æ˜¾ç¤ºå‰20ä¸ªæœ€ä¸¥é‡çš„)</h6>
            <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <div style="background: var(--dark-gradient); color: white; padding: 15px; display: grid; grid-template-columns: 1fr 1fr 2fr 1fr 1fr 1fr 1fr; gap: 10px; font-weight: 600; font-size: 0.85rem;">
                    <div>ä»£ç </div>
                    <div>å¸‚åœº</div>
                    <div>å®Œæ•´æ€§</div>
                    <div>åº”æœ‰</div>
                    <div>ç°æœ‰</div>
                    <div>ç¼ºå¤±</div>
                    <div>çŠ¶æ€</div>
                </div>
                ${details.slice(0, 20).map(stock => `
                <div style="padding: 12px 15px; display: grid; grid-template-columns: 1fr 1fr 2fr 1fr 1fr 1fr 1fr; gap: 10px; border-bottom: 1px solid #e9ecef; font-size: 0.85rem; align-items: center;">
                    <div style="font-weight: 600;">${stock.code}</div>
                    <div>${stock.market}</div>
                    <div>
                        <div style="background: #f8f9fa; height: 20px; border-radius: 10px; overflow: hidden; margin-bottom: 5px;">
                            <div style="background: ${stock.completeness >= 90 ? 'var(--success-gradient)' : stock.completeness >= 50 ? 'var(--info-gradient)' : 'var(--warning-gradient)'}; height: 100%; width: ${stock.completeness}%; transition: width 0.3s ease;"></div>
                        </div>
                        <div style="text-align: center; font-weight: 600; color: ${stock.completeness >= 90 ? '#4ecdc4' : stock.completeness >= 50 ? '#4facfe' : '#f093fb'};">${stock.completeness}%</div>
                    </div>
                    <div>${stock.total_expected}</div>
                    <div>${stock.existing_count}</div>
                    <div style="color: #f093fb; font-weight: 600;">${stock.missing_count}</div>
                    <div>
                        ${stock.completeness >= 90 ? '<span style="background: var(--success-gradient); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">å®Œæ•´</span>' : 
                          stock.completeness >= 50 ? '<span style="background: var(--info-gradient); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">éƒ¨åˆ†ç¼ºå¤±</span>' : 
                          '<span style="background: var(--warning-gradient); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">ä¸¥é‡ç¼ºå¤±</span>'}
                    </div>
                </div>
                `).join('')}
            </div>
        </div>
        ` : ''}
    `;
    
    $('#checkResult').html(resultHtml);
    $('#checkResultBox').slideDown(300);
}

// æ˜¾ç¤ºæ•°æ®è¡¥é½å¯¹è¯æ¡†
function showSupplementModal() {
    if (!checkResultData || !checkResultData.has_missing) {
        return;
    }
    
    const missingCount = checkResultData.missing_count;
    const sampleDates = checkResultData.missing_dates.slice(0, 5); // æ˜¾ç¤ºå‰5ä¸ªæ—¥æœŸä½œä¸ºç¤ºä¾‹
    
    const detailsHtml = `
        <div class="alert alert-info">
            <strong>ç¼ºå¤±æ•°æ®ç»Ÿè®¡ï¼š</strong><br>
            æ€»è®¡ç¼ºå¤± <strong>${missingCount}</strong> ä¸ªäº¤æ˜“æ—¥çš„æ•°æ®
        </div>
        
        <div class="well">
            <strong>ç¼ºå¤±æ—¥æœŸç¤ºä¾‹ï¼ˆå‰5ä¸ªï¼‰ï¼š</strong><br>
            ${sampleDates.map(date => `<span class="label label-warning">${date}</span>`).join(' ')}
            ${missingCount > 5 ? `<br><small class="text-muted">... è¿˜æœ‰ ${missingCount - 5} ä¸ªæ—¥æœŸ</small>` : ''}
        </div>
    `;
    
    $('#missingDataDetails').html(detailsHtml);
    $('#supplementModal').modal('show');
}

// ç¡®è®¤è¡¥é½æ•°æ®
function confirmSupplement() {
    if (!checkResultData) {
        return;
    }
    
    $('#supplementModal').modal('hide');
    
    // æ ¹æ®æ£€æŸ¥èŒƒå›´å‘é€ä¸åŒçš„è¡¥é½è¯·æ±‚
    const scope = checkResultData.check_scope;
    let requestData = {
        action: 'supplement_data'
    };
    
    if (scope === 'single') {
        // å•ä¸ªè‚¡ç¥¨è¡¥é½
        requestData.stock_code = checkResultData.stock_code;
        requestData.missing_dates = JSON.stringify(checkResultData.missing_dates);
    } else {
        // æ‰¹é‡è¡¥é½
        requestData.check_scope = scope;
        requestData.market = checkResultData.market || 'ALL';
        requestData.start_date = checkResultData.start_date;
        requestData.end_date = checkResultData.end_date;
        
        // ä¼ é€’éœ€è¦è¡¥é½çš„è‚¡ç¥¨åˆ—è¡¨
        if (checkResultData.details && checkResultData.details.length > 0) {
            const missingStocks = checkResultData.details.map(stock => ({
                code: stock.code,
                market: stock.market,
                missing_count: stock.missing_count
            }));
            requestData.missing_stocks = JSON.stringify(missingStocks);
        }
    }
    
    // å¼€å§‹è¡¥é½ä»»åŠ¡
    $.post('/instock/data_download_api', requestData, function(response) {
        if (response.success) {
            const message = scope === 'single' ? 
                'æ•°æ®è¡¥é½ä»»åŠ¡å·²å¯åŠ¨ï¼Œè¯·ç¨åé‡æ–°æ£€æŸ¥æ•°æ®å®Œæ•´æ€§' : 
                `æ‰¹é‡æ•°æ®è¡¥é½ä»»åŠ¡å·²å¯åŠ¨ï¼Œå°†ä¸º${checkResultData.summary.partial_missing + checkResultData.summary.severe_missing}åªè‚¡ç¥¨è¡¥é½æ•°æ®`;
            showAlert(message, 'info');
            
            // è·Ÿè¸ªä»»åŠ¡è¿›åº¦
            trackTaskProgress(response.task_id, 'supplement');
        } else {
            showAlert(response.message, 'danger');
        }
    }).fail(function() {
        showAlert('è¡¥é½è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'danger');
    });
}

// å¼€å§‹ä¸‹è½½
function startDownload() {
    const stockCode = $('#stockCode').val().trim();
    const startDate = $('#startDate').val();
    const endDate = $('#endDate').val();
    const writeToDb = $('#writeToDb').is(':checked');
    
    if (!stockCode || !startDate || !endDate) {
        showAlert('è¯·å¡«å†™å®Œæ•´çš„ä¸‹è½½å‚æ•°', 'warning');
        return;
    }
    
    // ç¦ç”¨ä¸‹è½½æŒ‰é’®
    $('#downloadBtn').prop('disabled', true);
    
    // æ˜¾ç¤ºè¿›åº¦æ¡†
    $('#progressBox').show();
    updateProgress(0, 'æ­£åœ¨åˆ›å»ºä¸‹è½½ä»»åŠ¡...');
    
    // å‘é€ä¸‹è½½è¯·æ±‚
    $.post('/instock/data_download_api', {
        action: 'download_data',
        stock_code: stockCode,
        start_date: startDate,
        end_date: endDate,
        write_to_db: writeToDb
    }, function(response) {
        if (response.success) {
            currentTaskId = response.task_id;
            showAlert(response.message, 'info');
            // å¼€å§‹è·Ÿè¸ªä»»åŠ¡è¿›åº¦
            trackTaskProgress(response.task_id, 'download');
        } else {
            showAlert(response.message, 'danger');
            $('#downloadBtn').prop('disabled', false);
            $('#progressBox').hide();
        }
    }).fail(function() {
        showAlert('ä¸‹è½½è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'danger');
        $('#downloadBtn').prop('disabled', false);
        $('#progressBox').hide();
    });
}

// è·Ÿè¸ªä»»åŠ¡è¿›åº¦
function trackTaskProgress(taskId, taskType) {
    const checkProgress = function() {
        $.post('/instock/data_download_api', {
            action: 'get_task_status',
            task_id: taskId
        }, function(response) {
            if (response.success) {
                const task = response.task;
                updateProgress(task.progress, task.message);
                
                if (task.status === 'completed') {
                    if (taskType === 'download') {
                        showDownloadResult(task);
                    } else if (taskType === 'supplement') {
                        if (task.type === 'batch_supplement') {
                            showBatchSupplementResult(task);
                        } else {
                            showAlert('ä»»åŠ¡å®Œæˆï¼š' + task.message, 'success');
                        }
                    }
                    $('#downloadBtn').prop('disabled', false);
                } else if (task.status === 'failed') {
                    showAlert('ä»»åŠ¡å¤±è´¥ï¼š' + task.message, 'danger');
                    $('#downloadBtn').prop('disabled', false);
                } else {
                    // ç»§ç»­æ£€æŸ¥è¿›åº¦
                    setTimeout(checkProgress, 2000);
                }
            } else {
                showAlert('è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥', 'danger');
                $('#downloadBtn').prop('disabled', false);
            }
        }).fail(function() {
            showAlert('ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢å¤±è´¥', 'danger');
            $('#downloadBtn').prop('disabled', false);
        });
    };
    
    checkProgress();
}

// æ˜¾ç¤ºæ‰¹é‡è¡¥é½ç»“æœ
function showBatchSupplementResult(task) {
    const resultHtml = `
        <div class="alert alert-${task.success_count === task.total_count ? 'success' : 'warning'}">
            <h5><i class="fa fa-${task.success_count === task.total_count ? 'check-circle' : 'exclamation-triangle'}"></i> æ‰¹é‡è¡¥é½å®Œæˆ</h5>
            <p><strong>æˆåŠŸè¡¥é½ï¼š</strong> ${task.success_count}/${task.total_count} åªè‚¡ç¥¨</p>
            <p><strong>å»ºè®®ï¼š</strong> è¯·é‡æ–°æ£€æŸ¥æ•°æ®å®Œæ•´æ€§ä»¥éªŒè¯è¡¥é½æ•ˆæœ</p>
            <button type="button" class="btn btn-info btn-sm" onclick="checkDataCompleteness()">
                <i class="fa fa-refresh"></i> é‡æ–°æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
            </button>
        </div>
    `;
    
    $('#downloadResult').html(resultHtml).show();
    updateProgress(100, task.message);
    
    const alertType = task.success_count === task.total_count ? 'success' : 'warning';
    showAlert(`æ‰¹é‡æ•°æ®è¡¥é½å®Œæˆï¼ŒæˆåŠŸè¡¥é½ ${task.success_count}/${task.total_count} åªè‚¡ç¥¨`, alertType);
}

// æ›´æ–°è¿›åº¦
function updateProgress(progress, message) {
    $('#progressBar').css('width', progress + '%').attr('aria-valuenow', progress);
    $('#progressMessage').text(message);
    
    // æ·»åŠ è¿›åº¦åŠ¨ç”»æ•ˆæœ
    if (progress === 100) {
        $('#progressBar').css('background', 'var(--success-gradient)');
        setTimeout(() => {
            $('#progressMessage').html('<i class="fa fa-check-circle" style="color: #4ecdc4;"></i> ' + message);
        }, 300);
    }
}

// æ˜¾ç¤ºä¸‹è½½ç»“æœ
function showDownloadResult(task) {
    const resultHtml = `
        <div class="modern-alert modern-alert-success">
            <h5 style="margin-bottom: 15px;"><i class="fa fa-check-circle"></i> ä¸‹è½½ä»»åŠ¡å®Œæˆ</h5>
            <div style="display: grid; gap: 10px; margin-bottom: 15px;">
                <div><strong>æ•°æ®è®°å½•:</strong> <span style="color: #4ecdc4;">${task.record_count} æ¡</span></div>
                <div><strong>æ–‡ä»¶å:</strong> <span style="color: #667eea;">${task.filename}</span></div>
            </div>
            <a href="${task.download_url}" class="modern-btn modern-btn-success" download>
                <i class="fa fa-download"></i> ç«‹å³ä¸‹è½½æ–‡ä»¶
            </a>
        </div>
    `;
    
    $('#downloadResult').html(resultHtml).slideDown(300);
    updateProgress(100, task.message);
    
    showAlert('æ•°æ®ä¸‹è½½å®Œæˆï¼Œç‚¹å‡»æŒ‰é’®ä¿å­˜æ–‡ä»¶', 'success');
}

// æ˜¾ç¤ºæ¶ˆæ¯æé†’
function showAlert(message, type) {
    // ç§»é™¤ç°æœ‰çš„alert
    $('.modern-page .alert-dismissible').fadeOut(200, function() {
        $(this).remove();
    });
    
    let alertClass = 'modern-alert-info';
    let iconClass = 'fa-info-circle';
    
    switch(type) {
        case 'success':
            alertClass = 'modern-alert-success';
            iconClass = 'fa-check-circle';
            break;
        case 'warning':
            alertClass = 'modern-alert-warning';
            iconClass = 'fa-exclamation-triangle';
            break;
        case 'danger':
        case 'error':
            alertClass = 'modern-alert-warning';
            iconClass = 'fa-exclamation-triangle';
            break;
    }
    
    const alertHtml = `
        <div class="modern-alert ${alertClass} alert-dismissible fade-in" style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
            <button type="button" class="close" style="position: absolute; right: 15px; top: 15px; color: inherit; opacity: 0.7; border: none; background: none; font-size: 1.2rem; cursor: pointer;">
                <span>&times;</span>
            </button>
            <div style="padding-right: 30px;">
                <i class="fa ${iconClass}"></i> ${message}
            </div>
        </div>
    `;
    
    $('body').append(alertHtml);
    
    // ç»‘å®šå…³é—­äº‹ä»¶
    $('.alert-dismissible .close').click(function() {
        $(this).parent().fadeOut(200, function() {
            $(this).remove();
        });
    });
    
    // è‡ªåŠ¨æ¶ˆå¤±
    setTimeout(function() {
        $('.alert-dismissible').fadeOut(200, function() {
            $(this).remove();
        });
    }, 5000);
}
</script>

{% end %}
